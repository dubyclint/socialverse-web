-- Cleanup duplicate/conflicting tables
-- Migration: 003_cleanup_duplicate_tables
-- Created: 2024-01-15

-- Drop conflicting tables if they exist (from setup-*.sql files)
DROP TABLE IF EXISTS public.users CASCADE;

-- Verify posts table has user_id column
ALTER TABLE posts
ADD COLUMN IF NOT EXISTS user_id UUID NOT NULL;

-- Add foreign key constraint if not exists
ALTER TABLE posts
ADD CONSTRAINT posts_user_id_fk FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE;

-- Verify trades table structure
ALTER TABLE trades
ADD COLUMN IF NOT EXISTS buyer_id UUID NOT NULL,
ADD COLUMN IF NOT EXISTS seller_id UUID NOT NULL;

-- Add foreign key constraints for trades
ALTER TABLE trades
ADD CONSTRAINT trades_buyer_id_fk FOREIGN KEY (buyer_id) REFERENCES profiles(id) ON DELETE CASCADE,
ADD CONSTRAINT trades_seller_id_fk FOREIGN KEY (seller_id) REFERENCES profiles(id) ON DELETE CASCADE;

SELECT 'Migration 003 completed: Cleaned up duplicate tables and added constraints' as status;
